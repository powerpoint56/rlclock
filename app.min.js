"use strict";function arrayLastElement(a){return a[a.length-1]}Date.now||(Date.now=function(){return(new Date).getTime()}),function(){function a(a,b,c){var d=new XMLHttpRequest;d.open("GET",a),d.addEventListener("load",b),d.addEventListener("error",c),d.send()}function b(a){k.data.notifications&&c("RL Schedule",a||g.minutesLeft.textContent)}function c(a,b){function c(){j&&setTimeout(j.close.bind(j),5e3),j=new window.Notification(b,{title:a})}return window.Notification?void("granted"===window.Notification.permission?c():"denied"!==window.Notification.permission&&window.Notification.requestPermission(function(a){"granted"===a&&c()})):alert("Notifications not supported.")}var d,e=2,f=new Date,g={id:function(a){return this.elements[a]||(this.elements[a]=document.getElementById(a))},elements:{}},h={loadSchedule:function(a){return this.isSchool=void 0!==a.periods,this.isSchool?(this.setupDay(a),this.prepareScheduleDOM(),void this.checkReady()):this.noSchool()},setupDay:function(a){this.periods=a.periods,this.hallLength=a.hallLength,"Hall"===this.periods[1].name&&(this.hallLength=this.fullMinutes(this.periods[1].end)-this.fullMinutes(this.periods[1].start)),this.firstPeriod=1,this.hallLength&&this.firstPeriod++,this.dayLetter=this.periods[this.firstPeriod].block,this.dayName=this.dayLetter,this.hallLength&&(this.dayName+="-"+this.hallLength),this.lunchPeriod=this.hallLength>=45?3:4},error:function(){e++,g.id("periods-list").textContent="Sorry, there has been an error. Please try reloading soon.",g.id("periods-list").style.display="block"},noSchool:function(){var a,b=f.getDay();a=6===b||0===b?"Weekend":"No School",g.id("current-title").textContent=a},prepareScheduleDOM:function(){for(var a=document.createDocumentFragment(),b=0,c=this.periods.length,d=0;c>d;d++){var e=this.periods[d];e.startMinutes=this.fullMinutes(e.start),e.endMinutes=this.fullMinutes(e.end),e.period===this.lunchPeriod&&(e.lunch=b++);var f=document.createElement("div");f.className="list-item";var h=document.createElement("span");h.className="list-item-letter",h.textContent=this.periodName(e),f.appendChild(h);var i=document.createElement("span");i.className="list-item-time",i.textContent=this.formatMinutesAsTime(e.startMinutes)+"-"+this.formatMinutesAsTime(e.endMinutes),f.appendChild(i),a.appendChild(f)}this.periodsListBlocks=a,g.id("periods-list-heading").textContent=this.dayName,g.id("periods-list-blocks").appendChild(this.periodsListBlocks),g.id("periods-list").style.display="block",g.id("about").style.display="block"},checkReady:function(){--e||(this.start=495,this.end=arrayLastElement(this.periods).endMinutes,this.update(!0))},periodName:function(a){return a.period===this.lunchPeriod?a.block+" - "+["First Lunch","In Between Lunches","Second Lunch"][a.lunch]:a.block||a.name},isDrop:function(){return 6===arrayLastElement(this.periods).period},getRelativePeriod:function(a){return this.periodName(this.periods[this.currentPeriod+a])},updatePeriod:function(){if(void 0===this.currentPeriod)for(var a=0;a<this.periods.length;a++){var b=this.periods[a];if(d>=b.startMinutes&&d<b.endMinutes+5){this.currentPeriod=a;break}}else this.currentPeriod++;this.minutesLeft=this.periods[this.currentPeriod].endMinutes-d},update:function(a){var c,e,h,i;f.setTime(Date.now()),a?d=this.fullMinutes(f.getHours(),f.getMinutes()):d++,d>=this.end?(e="After school",h=5!==f.getDay()?"Tomorrow starts with "+this.tomorrowDayType()+" block.":"The next school day starts with "+this.tomorrowDayType()+" block.",i=!0):d<this.start?(e="Before school",c=this.hoursMinutes(this.start-d),h=this.formatNumberUnit(c.hours,"hour"," and ")+this.formatNumberUnit(c.minutes,"minute"," until homeroom.")):(-4===this.minutesLeft||void 0===this.minutesLeft?(this.updatePeriod(a),e=this.getRelativePeriod(0)):this.minutesLeft--,this.minutesLeft<=0?(h="Passing time: "+this.formatNumberUnit(this.minutesLeft+5,"minute"," until ")+this.getRelativePeriod(1),0===this.minutesLeft&&b(this.getRelativePeriod(1)+" starts in 5 minutes.")):h=this.formatNumberUnit(this.minutesLeft,"minute"," left"),5===this.minutesLeft&&b("5 minutes left in "+this.getRelativePeriod(0))),e&&(g.id("current-title").textContent=e),h&&(g.id("current-description").textContent=h),i||setTimeout(this.update.bind(this),6e4-1e3*f.getSeconds())},tomorrowDayType:function(){var a="HGFEDCBA",b=a.indexOf(this.dayLetter)+1+this.isDrop();return a[b%8]},fullMinutes:function(a,b){if("string"==typeof a){var c=a.split(":");return 60*c[0]+1*c[1]}return"number"==typeof a?60*a+1*b:void 0},hoursMinutes:function(a){return{hours:Math.floor(a/60),minutes:a%60}},formatMinutesAsTime:function(a){var b=this.hoursMinutes(a);return b.minutes<10&&(b.minutes="0"+b.minutes),(b.hours%12||12)+":"+b.minutes},formatNumberUnit:function(a,b,c){return 0===a?"":1===a?a+" "+b+(c||""):a+" "+b+"s"+(c||"")}},i="//casper.roxburylatin.org/";a(i+"todays_schedule.json",function(){h.loadSchedule(JSON.parse(this.responseText))},h.error),addEventListener("DOMContentLoaded",function l(){removeEventListener("DOMContentLoaded",l),h.checkReady(),k.load(),g.id("settings-button").addEventListener("click",k.toggle.bind(k))});var j,k={data:{notifications:!1},load:function(){this.data=JSON.parse(localStorage.getItem("settings"))||this.data},prepareDOM:function(){var a;this.allSettings=g.id("settings").getElementsByTagName("input");for(var b=0;b<this.allSettings.length;b++)a=this.allSettings[b],a.checked=this.data[a.getAttribute("data-rep")];g.id("settings-submit").addEventListener("click",this.submit.bind(this)),this.isDOMReady=!0},save:function(){for(var a,b=0;b<this.allSettings.length;b++)a=this.allSettings[b],this.data[a.getAttribute("data-rep")]=a.checked;localStorage.setItem("settings",JSON.stringify(this.data))},submit:function(){this.save(),this.toggle()},toggle:function(){this.isDOMReady||this.prepareDOM(),g.id("settings").classList.toggle("appear")}}}();
